#!/usr/bin/env php
<?php

if (!is_callable('exec')) {
    echo "âŒ El sistema no permite ejecuciÃ³n de comandos.\n";
    exit(1);
}

// âœ… FunciÃ³n robusta para verificar PATH
function yervix_path_check(): void {
    $realBinDir = realpath(__DIR__); // Ruta donde estÃ¡ este script
    $systemPath = getenv('PATH');

    // Mostrar advertencia solo si el directorio no estÃ¡ en PATH
    if (!str_contains($systemPath, $realBinDir)) {
        if (strncasecmp(PHP_OS, 'WIN', 3) === 0) {
            echo "âš ï¸ El comando `yervix` podrÃ­a no estar en tu PATH.\n";
            echo "â„¹ï¸ Agrega esta ruta al PATH de tu sistema:\n";
            echo "   $realBinDir\n";
        } else {
            echo "âš ï¸ El comando `yervix` podrÃ­a no estar en tu PATH.\n";
            echo "ðŸ‘‰ Puedes agregarlo ejecutando:\n";
            echo "   export PATH=\"$realBinDir:\$PATH\"\n";
        }
    }
}

// ðŸ§ª Ejecuta el chequeo al inicio
yervix_path_check();

// ðŸ§­ LÃ³gica del CLI
$command = $argv[1] ?? null;
$arg = $argv[2] ?? null;

switch ($command) {
    case 'new':
        if (!$arg) {
            echo "âŒ Debes indicar el nombre del proyecto.\n";
            echo "â„¹ï¸ Uso: yervix new nombre-del-proyecto\n";
            exit(1);
        }
        require __DIR__ . '/cli/installer.php';
        yervix_install_project($arg);
        break;

        case 'serve':
        echo "ðŸš€ Iniciando servidor Yervix...\n";
        echo "ðŸ“¦ Ejecutando: php -S localhost:8000 index.php\n";

        // âœ… Abrir navegador directamente con la ruta final
        if (strncasecmp(PHP_OS, 'WIN', 3) === 0) {
            pclose(popen("start http://localhost:8000", "r"));
        } else {
            shell_exec("xdg-open http://localhost:8000");
        }

        // ðŸ§  Ejecutar servidor en primer plano
        passthru("php -S localhost:8000 index.php");
        break;

    default:
        echo "ðŸ§­ Comandos disponibles:\n";
        echo "   new     â†’ Instala el framework Yervix\n";
        echo "   serve   â†’ Levanta el servidor local\n";
        break;
}
